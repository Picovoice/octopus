<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>unit test - OctopusWeb</title>
  <script src="../dist/iife/index.js"></script>
  <script src="octopus_params.js"></script>
  <script src="test_results.js"></script>
  <script type="application/javascript">
    let pcm = null;

    const modelBase64 = {
      base64: modelParams,
      forceWrite: true,
    }

    window.onload = function() {
      const audioContext = new (window.AudioContext || window.webKitAudioContext)(
              { sampleRate: 16000 }
      );

      function readAudioFile(selectedFile, callback) {
        let reader = new FileReader();
        reader.onload = function (ev) {
          let wavBytes = reader.result;
          audioContext.decodeAudioData(wavBytes, callback);
        };
        reader.readAsArrayBuffer(selectedFile);
      }

      const fileSelector = document.getElementById("audioFile");
      fileSelector.addEventListener("change", (event) => {
        document.getElementById("audioLoaded").style.display = "none";

        writeMessage("Loading audio file...");
        const fileList = event.target.files;
        readAudioFile(fileList[0], (audioBuffer) => {
          const f32PCM = audioBuffer.getChannelData(0);
          const i16PCM = new Int16Array(f32PCM.length);

          const INT16_MAX = 32767;
          const INT16_MIN = -32768;
          i16PCM.set(
                  f32PCM.map((f) => {
                    let i = Math.trunc(f * INT16_MAX);
                    if (f > INT16_MAX) i = INT16_MAX;
                    if (f < INT16_MIN) i = INT16_MIN;
                    return i;
                  })
          );
          pcm = i16PCM;
          document.getElementById("audioLoaded").style.display = "block";
          writeMessage("Loading audio file... done!");
        });
      });
    }

    function writeMessage(message) {
      console.log(message);
      let p = document.createElement("p");
      let text = document.createTextNode(message);
      p.appendChild(text);
      document.body.appendChild(p);
    }

    function assertEquals(expected, actual, eps, failureMessage) {
      if (Math.abs(expected - actual) > eps) {
        throw new Error(failureMessage);
      }
    }

    async function startTest() {
      document.getElementById("testComplete").style.display = "none";

      writeMessage("Starting test...");

      const accessKey = document.getElementById("accessKey").value;
      const language = document.getElementById("language").value;
      const modelFile = (language === "en") ? "octopus_params.pv" : `octopus_params_${language}.pv`

      const modelPublicPath = {
        publicPath: modelFile,
        forceWrite: true,
      }

      if (!pcm) {
        writeMessage("Audio file not provided...");
        return
      }

      writeMessage(`Testing for language: ${language}`);

      try {
        if (language === "en") {
          writeMessage("Init from base64...");
          let o = await OctopusWeb.Octopus.create(accessKey, modelBase64);
          o.release();
          writeMessage("Init from base64... done!")

          writeMessage("Init from public directory...");
          o = await OctopusWeb.Octopus.create(accessKey, modelPublicPath);
          o.release();
          writeMessage("Init from public directory... done!")

          writeMessage("Init worker from base64...");
          o = await OctopusWeb.OctopusWorker.create(accessKey, modelBase64);
          o.terminate();
          writeMessage("Init worker from base64... done!");
        }

        writeMessage("Init worker from public directory...");
        const handle = await OctopusWeb.OctopusWorker.create(accessKey, modelPublicPath);
        writeMessage("Init worker from public directory... done!");

        writeMessage("Indexing audio files...");
        const metadata = await handle.index(pcm);
        writeMessage("Indexing audio files... done!");

        for (const { phrase, expected } of testResults[language]) {
          writeMessage(`Checking keyword: ${phrase}...`);
          const res = await handle.search(metadata, phrase);
          if (res.length !== expected.length) {
            throw new Error(`Result length of ${res.length} did not match expected length of ${expected.length}`);
          }
          for (let i = 0; i < expected.length; i++) {
            assertEquals(expected[0].startSec, res[0].startSec, 0.001, `${phrase} start did not match, expected ${expected[0].startSec} got ${res[0].startSec}`);
            assertEquals(expected[0].endSec, res[0].endSec, 0.001, `${phrase} end did not match, expected ${expected[0].endSec} got ${res[0].endSec}`);
            assertEquals(expected[0].probability, res[0].probability, 0.001, `${phrase} probability did not match, expected ${expected[0].probability} got ${res[0].probability}`);
          }
          writeMessage(`Checking keyword: ${phrase}... done!`);
        }

        writeMessage("Test passed!")

      } catch (error) {
        writeMessage(error);
        writeMessage("Test failed!")
      } finally {
        document.getElementById("testComplete").style.display = "block";
      }
    }

    const numIterations = 15;
    async function performanceTest() {
      document.getElementById("testComplete").style.display = "none";

      const accessKey = document.getElementById("accessKey").value;
      const handle = await OctopusWeb.OctopusWorker.create(accessKey, modelBase64);
      let metadata = null;

      try {
        writeMessage("Starting index performance test!");
        let start = Date.now();
        for (let i = 0; i < numIterations; i++) {
          metadata = await handle.index(pcm);
        }
        let end = Date.now();
        writeMessage(`Index Performance: ${((end - start) / 1000) / numIterations}`);

        writeMessage("Starting search performance test!");
        start = Date.now();
        for (let i = 0; i < numIterations; i++) {
          await handle.search(metadata, "porcupine");
        }
        end = Date.now();
        writeMessage(`Search Performance: ${((end - start) / 1000) / numIterations}`);
      } catch (e) {
        writeMessage("Test failed!")
      } finally {
        document.getElementById("testComplete").style.display = "block";
      }
    }
  </script>
</head>

<body>
<h1>Octopus web binding test</h1>
<p>After entering the AccessKey and audio file, click the "Test Octopus" button. For the result, refer to the browser console.</p>

<p>
  <label for="accessKey">AccessKey string provided by
    <a href="https://picovoice.ai/console/">Picovoice Console</a>:</label>
  <input type="text" id="accessKey" name="accessKey" />
</p>

<p>
  <label for="language">Language to test:</label>
  <input type="text" id="language" name="language" value="en" />
</p>

<p>
  <label for="audioFile">Select audio file located on {PROJECT_ROOT}/res/audio/multiple_keywords.wav:</label>
  <input type="file" id="audioFile" name="audioFile" accept="audio/*" />
</p>

<input type="button" id="submit" value="Test Octopus" onclick="startTest()" />
<input type="button" id="perfTest" value="Test Octopus Performance" onclick="performanceTest()"/>

<br>

<h4 id="audioLoaded" style="display: none;">Audio file loaded!</h4>
<h4 id="testComplete" style="display: none;">Test Complete!</h4>
<hr />
</body>

</html>
